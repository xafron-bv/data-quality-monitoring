<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confusion Matrix Report Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .matrix-cell {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        .matrix-cell.diagonal {
            background-color: rgba(34, 197, 94, 0.1);
        }
        .matrix-cell.error {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .metric-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .good { background-color: #d1fae5; color: #065f46; }
        .medium { background-color: #fef3c7; color: #92400e; }
        .poor { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Confusion Matrix Report Viewer</h1>
            <p class="text-gray-600 mt-2">Analyze detection performance with confusion matrices</p>
        </header>

        <!-- File Upload -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload Confusion Matrix Report</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer" id="dropZone">
                <input type="file" id="fileInput" accept=".json" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="mt-2 text-sm text-gray-600">Drop your confusion_matrix_report.json file here or click to browse</p>
            </div>
            <div id="fileInfo" class="mt-4 hidden">
                <p class="text-sm text-gray-600">Selected file: <span id="fileName" class="font-medium"></span></p>
            </div>
        </div>

        <!-- Report Content -->
        <div id="reportContent" class="hidden space-y-8">
            <!-- Overall Summary -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-2xl font-semibold mb-4">Overall Performance Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500 mb-1">Accuracy</p>
                        <p id="overallAccuracy" class="text-2xl font-bold">-</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500 mb-1">Precision</p>
                        <p id="overallPrecision" class="text-2xl font-bold">-</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500 mb-1">Recall</p>
                        <p id="overallRecall" class="text-2xl font-bold">-</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500 mb-1">F1 Score</p>
                        <p id="overallF1" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>

            <!-- Detection Type Breakdown -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-2xl font-semibold mb-4">Detection Type Performance</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h3 class="font-semibold mb-3 text-red-600">Validation</h3>
                        <div id="validationMetrics" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-3 text-yellow-600">Pattern-based</h3>
                        <div id="patternMetrics" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-3 text-blue-600">ML-based</h3>
                        <div id="mlMetrics" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Field-by-Field Analysis -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-2xl font-semibold mb-4">Field-by-Field Analysis</h2>
                <div class="mb-4">
                    <label class="text-sm font-medium text-gray-700">Select Field:</label>
                    <select id="fieldSelector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">Choose a field...</option>
                    </select>
                </div>
                <div id="fieldAnalysis" class="hidden">
                    <!-- Confusion Matrix -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3">Confusion Matrix</h3>
                        <div id="confusionMatrix" class="overflow-x-auto"></div>
                    </div>
                    
                    <!-- Field Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Performance Metrics</h3>
                            <canvas id="fieldMetricsChart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Detection Distribution</h3>
                            <canvas id="fieldDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-3">Detailed Metrics</h3>
                        <div id="fieldDetailedMetrics" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- Comparative Analysis -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-2xl font-semibold mb-4">Comparative Field Performance</h2>
                <canvas id="comparativeChart" height="400"></canvas>
            </div>
        </div>
    </div>

    <script>
        let reportData = null;
        let fieldMetricsChart = null;
        let fieldDistributionChart = null;
        let comparativeChart = null;
        
        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (file.type !== 'application/json') {
                alert('Please upload a JSON file');
                return;
            }
            
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    reportData = JSON.parse(e.target.result);
                    displayReport();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function displayReport() {
            if (!reportData) return;
            
            document.getElementById('reportContent').classList.remove('hidden');
            
            // Display overall metrics
            displayOverallMetrics();
            
            // Display detection type metrics
            displayDetectionTypeMetrics();
            
            // Populate field selector
            populateFieldSelector();
            
            // Display comparative chart
            displayComparativeChart();
        }
        
        function displayOverallMetrics() {
            const overall = reportData.overall_metrics || {};
            document.getElementById('overallAccuracy').textContent = formatPercent(overall.accuracy);
            document.getElementById('overallPrecision').textContent = formatPercent(overall.precision);
            document.getElementById('overallRecall').textContent = formatPercent(overall.recall);
            document.getElementById('overallF1').textContent = formatPercent(overall.f1_score);
        }
        
        function displayDetectionTypeMetrics() {
            const byType = reportData.metrics_by_detection_type || {};
            
            displayTypeMetrics('validationMetrics', byType.validation || {});
            displayTypeMetrics('patternMetrics', byType.pattern_based || {});
            displayTypeMetrics('mlMetrics', byType.ml_based || {});
        }
        
        function displayTypeMetrics(elementId, metrics) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
                <div class="flex justify-between py-1">
                    <span class="text-sm text-gray-600">Precision:</span>
                    <span class="text-sm font-medium">${formatPercent(metrics.precision)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-sm text-gray-600">Recall:</span>
                    <span class="text-sm font-medium">${formatPercent(metrics.recall)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-sm text-gray-600">F1 Score:</span>
                    <span class="text-sm font-medium">${formatPercent(metrics.f1_score)}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-sm text-gray-600">Support:</span>
                    <span class="text-sm font-medium">${metrics.support || 0}</span>
                </div>
            `;
        }
        
        function populateFieldSelector() {
            const selector = document.getElementById('fieldSelector');
            const fields = Object.keys(reportData.per_field_analysis || {});
            
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                selector.appendChild(option);
            });
            
            selector.addEventListener('change', (e) => {
                if (e.target.value) {
                    displayFieldAnalysis(e.target.value);
                } else {
                    document.getElementById('fieldAnalysis').classList.add('hidden');
                }
            });
        }
        
        function displayFieldAnalysis(fieldName) {
            const fieldData = reportData.per_field_analysis[fieldName];
            if (!fieldData) return;
            
            document.getElementById('fieldAnalysis').classList.remove('hidden');
            
            // Display confusion matrix
            displayConfusionMatrix(fieldData.confusion_matrix);
            
            // Display field metrics charts
            displayFieldMetrics(fieldData);
            
            // Display detailed metrics
            displayFieldDetailedMetrics(fieldData);
        }
        
        function displayConfusionMatrix(matrix) {
            const container = document.getElementById('confusionMatrix');
            
            // Create table
            let html = '<table class="min-w-full"><thead><tr><th></th>';
            
            // Headers
            const labels = ['True Negative', 'False Positive', 'False Negative', 'True Positive'];
            labels.forEach(label => {
                html += `<th class="px-4 py-2 text-sm font-medium text-gray-700">${label}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Matrix data
            const matrixData = [
                ['Predicted Negative', matrix.true_negative || 0, matrix.false_negative || 0, 0, 0],
                ['Predicted Positive', matrix.false_positive || 0, matrix.true_positive || 0, 0, 0]
            ];
            
            matrixData.forEach((row, i) => {
                html += '<tr>';
                html += `<td class="px-4 py-2 text-sm font-medium text-gray-700">${row[0]}</td>`;
                
                for (let j = 1; j <= 2; j++) {
                    const value = row[j];
                    const isDiagonal = (i === 0 && j === 1) || (i === 1 && j === 2);
                    const cellClass = isDiagonal ? 'diagonal' : 'error';
                    html += `<td class="matrix-cell ${cellClass}">${value}</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function displayFieldMetrics(fieldData) {
            const metrics = fieldData.metrics || {};
            
            // Metrics chart
            if (fieldMetricsChart) fieldMetricsChart.destroy();
            
            const ctx1 = document.getElementById('fieldMetricsChart').getContext('2d');
            fieldMetricsChart = new Chart(ctx1, {
                type: 'radar',
                data: {
                    labels: ['Accuracy', 'Precision', 'Recall', 'F1 Score'],
                    datasets: [{
                        label: 'Performance',
                        data: [
                            metrics.accuracy || 0,
                            metrics.precision || 0,
                            metrics.recall || 0,
                            metrics.f1_score || 0
                        ],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Distribution chart
            if (fieldDistributionChart) fieldDistributionChart.destroy();
            
            const ctx2 = document.getElementById('fieldDistributionChart').getContext('2d');
            const matrix = fieldData.confusion_matrix || {};
            
            fieldDistributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['True Positive', 'True Negative', 'False Positive', 'False Negative'],
                    datasets: [{
                        data: [
                            matrix.true_positive || 0,
                            matrix.true_negative || 0,
                            matrix.false_positive || 0,
                            matrix.false_negative || 0
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(156, 163, 175, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(156, 163, 175, 1)',
                            'rgba(251, 146, 60, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function displayFieldDetailedMetrics(fieldData) {
            const metrics = fieldData.metrics || {};
            const container = document.getElementById('fieldDetailedMetrics');
            
            const metricItems = [
                { label: 'Accuracy', value: metrics.accuracy, type: 'percent' },
                { label: 'Precision', value: metrics.precision, type: 'percent' },
                { label: 'Recall', value: metrics.recall, type: 'percent' },
                { label: 'F1 Score', value: metrics.f1_score, type: 'percent' },
                { label: 'Support', value: metrics.support, type: 'number' },
                { label: 'True Positives', value: fieldData.confusion_matrix?.true_positive, type: 'number' },
                { label: 'False Positives', value: fieldData.confusion_matrix?.false_positive, type: 'number' },
                { label: 'False Negatives', value: fieldData.confusion_matrix?.false_negative, type: 'number' }
            ];
            
            container.innerHTML = metricItems.map(item => {
                const value = item.type === 'percent' ? formatPercent(item.value) : (item.value || 0);
                const badgeClass = getMetricBadgeClass(item.value, item.type);
                
                return `
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">${item.label}</p>
                        <p class="metric-badge ${badgeClass}">${value}</p>
                    </div>
                `;
            }).join('');
        }
        
        function displayComparativeChart() {
            const fields = Object.keys(reportData.per_field_analysis || {});
            const metrics = {
                precision: [],
                recall: [],
                f1_score: []
            };
            
            fields.forEach(field => {
                const fieldMetrics = reportData.per_field_analysis[field].metrics || {};
                metrics.precision.push(fieldMetrics.precision || 0);
                metrics.recall.push(fieldMetrics.recall || 0);
                metrics.f1_score.push(fieldMetrics.f1_score || 0);
            });
            
            if (comparativeChart) comparativeChart.destroy();
            
            const ctx = document.getElementById('comparativeChart').getContext('2d');
            comparativeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fields,
                    datasets: [
                        {
                            label: 'Precision',
                            data: metrics.precision,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Recall',
                            data: metrics.recall,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'F1 Score',
                            data: metrics.f1_score,
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y * 100).toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function formatPercent(value) {
            if (value === undefined || value === null) return '-';
            return (value * 100).toFixed(1) + '%';
        }
        
        function getMetricBadgeClass(value, type) {
            if (type === 'number') return 'medium';
            if (!value) return 'poor';
            if (value >= 0.8) return 'good';
            if (value >= 0.6) return 'medium';
            return 'poor';
        }
    </script>
</body>
</html>